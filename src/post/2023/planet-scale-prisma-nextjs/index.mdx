---
title: "PlanetScale + Prisma + Next.js 13で簡単サーバーレスを試してみる"
date: "2023-05-03"
path: "/blog/2023/planet-scale-prisma-nextjs"
tags: ["Next.js"]
description: "PlanetScale + Prisma + Next.js 13で簡単サーバーレスを試してみる。"
---

import LinkCard from "../../../components/LinkCard";

# 概要

PlanetScale + Prisma + Next.js 13 で簡単サーバーレスを試してみる

Prisma の公式ドキュメントにもガイドがある。
https://www.prisma.io/planetscale
https://www.prisma.io/docs/guides/database/planetscale
https://www.prisma.io/nextjs
https://dev.to/franciscomendes10866/build-a-full-stack-app-with-nextjs-tailwind-trpc-and-prisma-orm-4ail

PlanetScale の公式ドキュメントにもガイドがある。
https://planetscale.com/docs/prisma/automatic-prisma-migrations

# PlanetScaleの設定

まずはアカウントの作成。

<img src="./img/1.png" />

prisma-app という DB を作成。

<img src="./img/2.png" />

## PlanetScale で connect

Connect with で Prisma を選択。

Prisma の設定用の `.env` と `schema.prisma` のコードが出てくるので、[Prisma をセットアップ](/blog/2023/planet-scale-prisma-nextjs#prisma-%E3%81%AE%E5%88%9D%E6%9C%9F%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97)するときに自動で追加されるファイルにそのままコピペする。

<img src="./img/3.png" />

# Next.jsのセットアップ

今回は Next.js で試してるので、プロジェクトを作成する。

```shell
$ yarn create next-app --typescript next-prisma-app
```

Next.js 13 から beta 版で使えるようになった [App Directory](https://beta.nextjs.org/docs/app-directory-roadmap) を試してみたいので、以下には Yes を選択する。

```shell
? Would you like to use experimental `app/` directory with this project? › No / Yes
```

すると、`next.config.js` に設定が追加されるので、これで App Directory が使えるようになる。

```js:title=next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    appDir: true,
  },
}

module.exports = nextConfig

```

# Prismaの導入

Next.js で使うライブラリをインストールする。

```shell
$ yarn add -D prisma
```

```shell
$ yarn add @prisma/client
```

## Prisma の初期セットアップ。

```shell
$ npx prisma init
```

以下のファイルが自動生成される。

- `.env`
- `prisma/schema.prisma`

`.env` を `.gitignore` に追加する。

VS code の拡張機能をインストールする。
https://marketplace.visualstudio.com/items?itemName=Prisma.prisma

## 設定ファイルの編集

Connect with で Prisma を選択。

`.env` と `schema.prisma` 用のコードが出てくるので、先ほど自動で追加されたファイルにそのままコピペする。

## Model の追加

DB の Model を追加してみる。

```ts
model Post {
  id       Int       @id @default(autoincrement())
  title    String
  content  String
  likes    Int       @default(0)
  comments Comment[]
}

model Comment {
  id      Int    @id @default(autoincrement())
  comment String
  postId  Int
  post    Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}
```

`npx prisma db push` で DB に反映する。

実際には `yarn db:push` というコマンドを作っている。

```json:title=package.json
{
  "scripts": {
    "db:push": "prisma db push"
  }
}
```

成功。

```shell
$ prisma db push
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": MySQL database "prisma-app" at "aws.connect.psdb.cloud"

🚀  Your database is now in sync with your Prisma schema. Done in 1.14s

✔ Generated Prisma Client (4.13.0 | library) to ./node_modules/@prisma/client in 39ms

✨  Done in 3.46s.
```

### PlanetScale で確認

ちゃんとスキーマが反映されている。

<img src="./img/5.png" />

## Prisma StudioでDBにダミーデータを追加をする

Prisma には [Prisma Studio](https://www.prisma.io/studio) というローカルからデータベースを操作できる GUI のエディターが提供されている。
`npx prisma studio` を実行すると http://localhost:5555 で起動する。

試しに適当なデータを入れてみる。

<img src="./img/6.png" />

<LinkCard url="https://www.prisma.io/studio" />

# フロントから DB 操作する

## データを取得する

App Directory では Server components がデフォルトになっているので、まずはコンポーネント内で取得してみる。
https://nextjs.org/blog/next-13#new-app-directory-beta
https://beta.nextjs.org/docs/rendering/server-and-client-components#server-components

Next.js 12 までは SSR でデータ取得する際には `getServerSideProps` を使っていたが、RFC の async/await が使えるようになったので、以下のように書ける。

````tsx:title=src/app/posts/page.tsx

```tsx:title=src/app/posts/page.tsx
import type { Post } from "@prisma/client";
import { PrismaClient } from "@prisma/client";

async function getPosts() {
  const prisma = new PrismaClient();
  const posts: Post[] = await prisma.post.findMany();
  return posts;
}

export default async function Posts() {
  const posts = await getPosts();

  return (
    <main>
      <ul>
        {posts.map((post) => (
          <li key={post.id}>
            <p>title: {post.title}</p>
            <p>content: {post.content}</p>
            <p>likes: {post.likes}</p>
          </li>
        ))}
      </ul>
    </main>
  );
}
````

これまでの getStaticProps や getServerSideProps は fetch の cache オプションで表現できる。

<LinkCard url="https://nextjs.org/blog/next-13#data-fetching" />

<LinkCard url="https://nextjs.org" />
