---
title: "PlanetScale + Prisma + Next.js 13ã§ç°¡å˜ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚’è©¦ã—ã¦ã¿ã‚‹"
date: "2023-05-03"
path: "/blog/2023/planet-scale-prisma-nextjs"
tags: ["Next.js", "React", "Prisma", "PlanetScale"]
description: "PlanetScale + Prisma + Next.js 13ã§ç°¡å˜ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚’è©¦ã—ã¦ã¿ã‚‹ã€‚"
---

import LinkCard from "../../../components/LinkCard";

# æ¦‚è¦

PlanetScale + Prisma + Next.js 13 ã§ç°¡å˜ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚’è©¦ã—ã¦ã¿ã‚‹

ä»Šå›ã®æ¤œè¨¼ã§ä½¿ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚

- Next.js
  - 13.3.4
- React
  - 18.2.0
- TypeScript
  - 5.0.4
- Prisma
  - 4.13.0

Prisma ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚¬ã‚¤ãƒ‰ãŒã‚ã‚‹ã€‚

<LinkCard url="https://www.prisma.io/planetscale" />
<LinkCard url="https://www.prisma.io/docs/guides/database/planetscale" />
<LinkCard url="https://www.prisma.io/nextjs" />
<LinkCard url="https://dev.to/franciscomendes10866" />
<LinkCard url="https://dev.to/franciscomendes10866/build-a-full-stack-app-with-nextjs-tailwind-trpc-and-prisma-orm-4ail" />

PlanetScale ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚¬ã‚¤ãƒ‰ãŒã‚ã‚‹ã€‚
https://planetscale.com/docs/prisma/automatic-prisma-migrations

# PlanetScaleã®è¨­å®š

ã¾ãšã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã€‚

<img src="./img/1.png" />

prisma-app ã¨ã„ã† DB ã‚’ä½œæˆã€‚

<img src="./img/2.png" />

## PlanetScale ã§ connect

Connect with ã§ Prisma ã‚’é¸æŠã€‚

Prisma ã®è¨­å®šç”¨ã® `.env` ã¨ `schema.prisma` ã®ã‚³ãƒ¼ãƒ‰ãŒå‡ºã¦ãã‚‹ã®ã§ã€[Prisma ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](/blog/2023/planet-scale-prisma-nextjs#prisma-%E3%81%AE%E5%88%9D%E6%9C%9F%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97)ã™ã‚‹ã¨ãã«è‡ªå‹•ã§è¿½åŠ ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ãã®ã¾ã¾ã‚³ãƒ”ãƒšã™ã‚‹ã€‚

<img src="./img/3.png" />

# Next.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ä»Šå›ã¯ Next.js ã§è©¦ã—ã¦ã‚‹ã®ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚

```shell
$ yarn create next-app --typescript next-prisma-app
```

Next.js 13 ã‹ã‚‰ beta ç‰ˆã§ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸ [App Directory](https://beta.nextjs.org/docs/app-directory-roadmap) ã‚’è©¦ã—ã¦ã¿ãŸã„ã®ã§ã€ä»¥ä¸‹ã«ã¯ Yes ã‚’é¸æŠã™ã‚‹ã€‚

```shell
? Would you like to use experimental `app/` directory with this project? â€º No / Yes
```

ã™ã‚‹ã¨ã€`next.config.js` ã«è¨­å®šãŒè¿½åŠ ã•ã‚Œã‚‹ã®ã§ã€ã“ã‚Œã§ App Directory ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```js:title=next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    appDir: true,
  },
}

module.exports = nextConfig
```

<LinkCard url="https://beta.nextjs.org/docs/app-directory-roadmap" />

# Prismaã®å°å…¥

Next.js ã§ä½¿ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```shell
$ yarn add -D prisma
```

```shell
$ yarn add @prisma/client
```

## Prisma ã®åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€‚

```shell
$ npx prisma init
```

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã€‚

- `.env`
- `prisma/schema.prisma`

`.env` ã‚’ `.gitignore` ã«è¿½åŠ ã™ã‚‹ã€‚

VS code ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

<LinkCard url="https://marketplace.visualstudio.com/items?itemName=Prisma.prisma" />

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†

Connect with ã§ Prisma ã‚’é¸æŠã€‚

`.env` ã¨ `schema.prisma` ç”¨ã®ã‚³ãƒ¼ãƒ‰ãŒå‡ºã¦ãã‚‹ã®ã§ã€å…ˆã»ã©è‡ªå‹•ã§è¿½åŠ ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«ãã®ã¾ã¾ã‚³ãƒ”ãƒšã™ã‚‹ã€‚

## Model ã®è¿½åŠ 

DB ã® Model ã‚’è¿½åŠ ã—ã¦ã¿ã‚‹ã€‚

```ts
model Post {
  id       Int       @id @default(autoincrement())
  title    String
  content  String
  likes    Int       @default(0)
  comments Comment[]
}

model Comment {
  id      Int    @id @default(autoincrement())
  comment String
  postId  Int
  post    Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}
```

`npx prisma db push` ã§ DB ã«åæ˜ ã™ã‚‹ã€‚

å®Ÿéš›ã«ã¯ `yarn db:push` ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã‚’ä½œã£ã¦ã„ã‚‹ã€‚

```json:title=package.json
{
  "scripts": {
    "db:push": "prisma db push"
  }
}
```

æˆåŠŸã€‚

```shell
$ prisma db push
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": MySQL database "prisma-app" at "aws.connect.psdb.cloud"

ğŸš€  Your database is now in sync with your Prisma schema. Done in 1.14s

âœ” Generated Prisma Client (4.13.0 | library) to ./node_modules/@prisma/client in 39ms

âœ¨  Done in 3.46s.
```

### PlanetScale ã§ç¢ºèª

ã¡ã‚ƒã‚“ã¨ã‚¹ã‚­ãƒ¼ãƒãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã€‚

<img src="./img/5.png" />

## Prisma Studioã§DBã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã‚’ã™ã‚‹

Prisma ã«ã¯ [Prisma Studio](https://www.prisma.io/studio) ã¨ã„ã†ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ“ä½œã§ãã‚‹ GUI ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã€‚
`npx prisma studio` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ http://localhost:5555 ã§èµ·å‹•ã™ã‚‹ã€‚

è©¦ã—ã«é©å½“ãªãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¦ã¿ã‚‹ã€‚

<img src="./img/6.png" />

<LinkCard url="https://www.prisma.io/studio" />

# ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ DB æ“ä½œã™ã‚‹

## Server Componentã§å–å¾—ã™ã‚‹

App Directory ã§ã¯ Server components ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã¾ãšã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ prisma ã‚’ä½¿ã„ç›´æ¥å–å¾—ã—ã¦ã¿ã‚‹ã€‚
Next.js 12 ã¾ã§ã¯ SSR ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã™ã‚‹éš›ã«ã¯ `getServerSideProps` ã‚’ä½¿ã£ã¦ã„ãŸãŒã€RFC ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã§ã® `async`/`await` ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç›´æ¥çš„ã«æ›¸ã‘ã‚‹ã€‚

```tsx:title=src/app/posts/page.tsx
import type { Post } from "@prisma/client";
import { PrismaClient } from "@prisma/client";

async function getPosts() {
  const prisma = new PrismaClient();
  const posts: Post[] = await prisma.post.findMany();
  return posts;
}

export default async function Posts() {
  const posts = await getPosts();

  return (
    <main>
      <ul>
        {posts.map((post) => (
          <li key={post.id}>
            <p>title: {post.title}</p>
            <p>content: {post.content}</p>
            <p>likes: {post.likes}</p>
          </li>
        ))}
      </ul>
    </main>
  );
}
```

ã¾ãŸã€å°‘ã—ãƒã‚¿ãŒå¤ã„ãŒã€Next.js ãŒ `fetch` ã‚’æ‹¡å¼µã—ã¦ç‹¬è‡ªã® cache è¨­å®šãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã¾ã§ã® getStaticProps ã‚„ getServerSideProps ã¯ fetch ã® cache ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§è¡¨ç¾ã§ãã‚‹ã€‚

<LinkCard url="https://nextjs.org/blog/next-13#new-app-directory-beta" />
<LinkCard url="https://beta.nextjs.org/docs/rendering/server-and-client-components#server-components" />

## API routeã‹ã‚‰å–å¾—ã™ã‚‹

Next.js 13.2 ã‹ã‚‰ã¯ Custom Route Handlers ãŒè¿½åŠ ã•ã‚ŒãŸã®ã§ã€ãã‚Œã«å€£ã£ã¦ API ã‚’ä½œã£ã¦ã¿ã‚‹ã€‚

<LinkCard url="https://nextjs.org/blog/next-13-2#custom-route-handlers" />

Custom Route Handlers ã¯ app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã« `routes.js|ts` ã§å®šç¾©ã™ã‚‹ã¨ä½¿ãˆã‚‹ã€‚
`GET`, `POST`, `PUT`, `PATCH`, `DELETE`, `HEAD`, `OPTIONS` ã® HTTP ãƒ¡ã‚½ãƒƒãƒ‰ã«å¯¾å¿œã—ã¦ã„ã¦ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰åã§å®šç¾©ã•ã‚ŒãŸé–¢æ•°ã‚’ export ã™ã‚‹ã¨ã€ãã®ãƒ¡ã‚½ãƒƒãƒ‰ã® API ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

<LinkCard url="https://beta.nextjs.org/docs/api-reference/file-conventions/route" />

ä»Šå›ã¯ç‰¹ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ã‚’å—ã‘å–ã‚‰ãªã„é™çš„ãƒ«ãƒ¼ãƒˆã® API ã‚’å®Ÿè£…ã—ã¦ã¿ã‚‹ã€‚
prisma ã‚’ä½¿ã£ã¦ post ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å–å¾—ã—ãŸä¸€è¦§ã‚’è¿”ã™å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

```ts:title=src/app/api/posts/route.ts
import { prisma } from "@/lib/prisma";
import { NextResponse } from "next/server";

export async function GET() {
  const posts = await prisma.post.findMany();
  return NextResponse.json({ posts });
}
```

## Client Componentã§å–å¾—ã™ã‚‹

ä¸€è¦§ã‚’å–å¾—ã§ãã‚‹ API ãŒå‡ºæ¥ãŸã®ã§ã€ä»Šåº¦ã¯ Client Component ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ã—ã¦ã¿ã‚‹ã€‚
`"use client"` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ã†ã¨ client-side ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹ã€‚

<LinkCard url="https://beta.nextjs.org/docs/rendering/server-and-client-components#client-components" />

å®Ÿéš›ã« `"use client"` ã‚’ä½¿ã£ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚
Next.js 13 ã‹ã‚‰ã¯ `use` ã‚‚è¿½åŠ ã•ã‚ŒãŸã®ã§ã€ãŠè©¦ã—ã§ä½¿ã£ã¦ã¿ã‚‹ã€‚
ãŸã ã€æ³¨æ„ç‚¹ã¨ã—ã¦ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ `fetch` ã‚’ãƒ©ãƒƒãƒ—ã—ãŸ `use` ã¯è¤‡æ•°ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’èª˜ç™ºã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã¨ã®ã“ã¨ã§ã€[SWR](https://swr.vercel.app/ja)ã‚„[TanStack Query(React Query)](https://tanstack.com/query/latest)ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã€‚

<LinkCard url="https://beta.nextjs.org/docs/data-fetching/fetching#use-in-client-components" />

å®Ÿéš›ã« API ã‹ã‚‰å–å¾—ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…ã€‚

```tsx:title=src/components/Posts.tsx
"use client";

import { Post } from "@prisma/client";
import { use } from "react";

const getPosts = async () => {
  const res = await fetch(`http://localhost:3000/api/posts`);
  const data = await res.json();
  return data as Post[];
};

export default function Posts() {
  const posts = use(getPosts());

  return (
    <ul>
      {posts.map((post) => (
        <li key={post.id}>
          <p>title: {post.title}</p>
          <p>content: {post.content}</p>
          <p>likes: {post.likes}</p>
        </li>
      ))}
    </ul>
  );
}
```

```tsx:title=src/app/posts/page.tsx
import { Suspense } from "react";
import Posts from "@/components/Posts";

export default function PostsPage() {
  return (
    <Suspense fallback={<p>Loading...</p>}>
      <Posts />
    </Suspense>
  );
}
```

<LinkCard url="https://beta.nextjs.org/docs/routing/route-handlers" />

## å‹•çš„ãƒ«ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã™ã‚‹

è©³ç´°ãƒšãƒ¼ã‚¸ãªã©ã§å€‹åˆ¥ã®å‹•çš„ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã€å‹•çš„ãƒ«ãƒ¼ãƒˆã® API ã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ä»Šå›ã¯ã€`/api/posts/[id]`ã®ã‚ˆã†ã«ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å–å¾—ã§ãã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œã£ã¦ã¿ã‚‹ã€‚
`params` ã‹ã‚‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåï¼ˆ`[id]`ï¼‰ã«æŒ‡å®šã—ãŸ id ã®å€¤ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ãªã®ã§ã€ãã‚Œã‚’ä½¿ã£ã¦ prisma çµŒç”±ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã€‚

```ts:title=src/app/api/posts/[id]/route.ts
import { prisma } from "@/lib/prisma";
import { NextResponse } from "next/server";

export async function GET(
  _req: Request,
  { params }: { params: { id: string } }
) {
  const post = await prisma.post.findUnique({
    where: {
      id: Number(params.id),
    },
  });

  if (post === null) {
    return new NextResponse(null, { status: 404 });
  }

  return NextResponse.json(post);
}
```

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã‚‚ `params` ã‹ã‚‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåï¼ˆ`[id]`ï¼‰ã«æŒ‡å®šã—ãŸ id ã®å€¤ã‚’å–å¾—ã§ãã‚‹ã®ã§ã€ãã‚Œã‚’ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«æŒ‡å®šã—ã¦å–å¾—ã™ã‚‹ã€‚
Server Component ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚‹ã€‚

```tsx:title=src/app/posts/[id]/page.tsx
import type { Post } from "@prisma/client";

async function getPost(id: string) {
  const res = await fetch(`http://localhost:3000/api/posts/${id}`, {
    next: { revalidate: 60 },
  });

  const data = await res.json();
  return data as Post;
}

export default async function PostPage({ params }: { params: { id: string } }) {
  const post = await getPost(params.id);

  return (
    <main>
      <p>title: {post.title}</p>
      <p>content: {post.content}</p>
      <p>likes: {post.likes}</p>
    </main>
  );
}
```

## ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹

ä¸€è¦§å–å¾—æ™‚ã«å®Ÿè£…ã—ãŸ `/api/posts` ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã« POST ç”¨ã®é–¢æ•°ã‚’è¿½åŠ ã™ã‚‹ã€‚
`prisma` ã® `create` ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹ã€‚

```ts:title=src/app/api/posts/route.ts
...
export async function POST(request: Request) {
  const data = await request.json();

  const post = await prisma.post.create({
    data: { title: data.title, content: data.content },
  });

  return new NextResponse(`${post.id}`, { status: 201 });
}
```
